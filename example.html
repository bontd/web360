<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Cube Simple</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }

        #instructions {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="status">S·∫µn s√†ng</div>
        <div id="instructions">
            üñ±Ô∏è K√©o chu·ªôt ƒë·ªÉ xoay | üîç Cu·ªôn chu·ªôt ƒë·ªÉ zoom
        </div>
    </div>

    <script type="module">
        import * as THREE from './three.js/build/three.module.min.js';
        
        let scene, camera, renderer, model, backgroundSphere;
        let video, canvas;
        let isCameraActive = false;
        let isMouseDown = false;
        let mouseX = 0, mouseY = 0;
        let targetRotationX = 0, targetRotationY = 0;
        let rotationX = 0, rotationY = 0;
        let targetZoom = 5; // Target zoom distance
        let currentZoom = 5; // Current zoom distance

        const status = document.getElementById('status');

        // Initialize immediately when Three.js loads
        function init() {
            console.log('Starting init function...');
            
            // Scene
            scene = new THREE.Scene();
            console.log('Scene created');

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 5); // N√¢ng camera l√™n m·ªôt ch√∫t
            camera.lookAt(0, 0, 0); // Nh√¨n v√†o t√¢m
            console.log('Camera created');

            // Renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('canvas'),
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            console.log('Renderer created');

            // Video element
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');

            // Set background texture t·ª´ ·∫£nh alma.jpg
            const loader = new THREE.TextureLoader();
            const backgroundTexture = loader.load('./tour360/alma.jpg');
            scene.background = backgroundTexture;
            
            // Simple lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambientLight);
            console.log('Lighting added');

            // Create building model immediately
            createBuilding();
            status.textContent = 'H√¨nh vu√¥ng ƒë√£ s·∫µn s√†ng';
            console.log('Building created');

            // Mouse controls
            canvas.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            });

            canvas.addEventListener('mouseup', () => {
                isMouseDown = false;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isMouseDown) {
                    const deltaX = e.clientX - mouseX;
                    const deltaY = e.clientY - mouseY;
                    
                    targetRotationY += deltaX * 0.02; // TƒÉng t·ªëc ƒë·ªô xoay
                    targetRotationX += deltaY * 0.02;
                    
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                }
            });

            // Zoom with mouse wheel - smooth zoom
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomSpeed = 0.5;
                if (e.deltaY > 0) {
                    targetZoom += zoomSpeed;
                } else {
                    targetZoom -= zoomSpeed;
                }
                // Gi·ªõi h·∫°n zoom trong kho·∫£ng 2-10
                targetZoom = Math.max(2, Math.min(10, targetZoom));
            });

            // Window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // Start animation loop
            animate();

            // Start camera after a short delay
            setTimeout(startCamera, 1000);

            console.log('init');
            
        }

        function createBuilding() {
            console.log('Creating building...');
            
            // T·∫°o m·ªôt h√¨nh vu√¥ng ƒë∆°n gi·∫£n
            model = new THREE.Mesh(
                new THREE.BoxGeometry(2, 2, 2),
                new THREE.MeshBasicMaterial({ color: 0xFF0000 }) // M√†u ƒë·ªè ƒë·ªÉ d·ªÖ th·∫•y
            );
            model.position.set(0, 0, 0); // ƒê·∫∑t ·ªü gi·ªØa
            scene.add(model);
            console.log('Red cube added');
            
            // Th√™m m·ªôt h√¨nh vu√¥ng nh·ªè h∆°n ƒë·ªÉ test
            const smallCube = new THREE.Mesh(
                new THREE.BoxGeometry(1, 1, 1),
                new THREE.MeshBasicMaterial({ color: 0x00FF00 }) // M√†u xanh l√°
            );
            smallCube.position.set(3, 0, 0);
            scene.add(smallCube);
            console.log('Green cube added');
            
            // T·∫°o sphere background l·ªõn v·ªõi texture alma.jpg
            const loader = new THREE.TextureLoader();
            const texture = loader.load('./tour360/alma.jpg');
            
            backgroundSphere = new THREE.Mesh(
                new THREE.SphereGeometry(50, 32, 32),
                new THREE.MeshBasicMaterial({ 
                    map: texture,
                    side: THREE.BackSide // Hi·ªÉn th·ªã m·∫∑t trong
                })
            );
            backgroundSphere.position.set(0, 0, 0);
            scene.add(backgroundSphere);
            console.log('Background sphere with alma.jpg added');
        }

        async function startCamera() {
            console.log('startCamera');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                
                video.srcObject = stream;
                video.play();
                
                isCameraActive = true;
                status.textContent = 'Camera ƒë√£ kh·ªüi ƒë·ªông';
            } catch (error) {
                console.error('L·ªói camera:', error);
                status.textContent = 'Kh√¥ng th·ªÉ truy c·∫≠p camera';
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // Smooth rotation - tƒÉng t·ªëc ƒë·ªô ƒë·ªÉ ph·∫£n h·ªìi nhanh h∆°n
            rotationX += (targetRotationX - rotationX) * 0.02;
            rotationY += (targetRotationY - rotationY) * 0.02;
            
            // Smooth zoom
            currentZoom += (targetZoom - currentZoom) * 0.15; // Zoom m∆∞·ª£t h∆°n v·ªõi t·ªëc ƒë·ªô 0.15
            camera.position.z = currentZoom;
            
            if (model) {
                model.rotation.x = rotationX;
                model.rotation.y = rotationY;
            }
            
            // Xoay background sphere theo camera
            if (backgroundSphere) {
                backgroundSphere.rotation.y = rotationY * 0.8; // Xoay ch·∫≠m h∆°n
                backgroundSphere.rotation.x = rotationX * 0.8;
            }
            
            // Render 3D scene
            renderer.render(scene, camera);
            
            // Overlay video
            if (isCameraActive && video.videoWidth > 0) {
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }
        }

        
        // Initialize immediately since THREE is imported
        console.log('Three.js imported successfully');
        init();
    </script>
</body>
</html>
