<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Plane Detection - Đặt mô hình trên mặt phẳng</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            user-select: none;
        }

        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        #instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 16px;
            line-height: 1.5;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 18px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
        }

        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            pointer-events: all;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        #model-selector {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: all;
        }

        .model-btn {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .model-btn.active {
            background: rgba(0, 123, 255, 0.8);
            border-color: rgba(0, 123, 255, 1);
        }

        .model-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .scanning-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .hidden {
            display: none !important;
        }

        .visible {
            opacity: 1 !important;
        }
    </style>
</head>
<body>
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    
    <div id="ui-container">
    <div id="status">Đang khởi tạo AR...</div>
        <div id="instructions">Đang tải camera và AR...</div>
    <div id="loading">Đang khởi tạo AR...</div>
        <div class="scanning-indicator" id="scanning"></div>
        
        <div id="controls">
            <button class="control-btn" id="reset-btn">Đặt lại</button>
            <button class="control-btn" id="info-btn">Thông tin</button>
        </div>
        
        <div id="model-selector">
            <button class="model-btn active" data-model="cube">Khối lập phương</button>
            <button class="model-btn" data-model="sphere">Hình cầu</button>
            <button class="model-btn" data-model="torus">Hình xuyến</button>
            <button class="model-btn" data-model="teapot">Ấm trà</button>
        </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // Global variables
        let scene, camera, renderer, video, canvas;
        let status, instructions, loading, scanning, modelSelector;
        let placedModel = null;
        let currentModelType = 'cube';
        let animationId = null;
        let cameraStream = null;

        // DOM elements
        const elements = {
            video: null,
            canvas: null,
            status: null,
            instructions: null,
            loading: null,
            scanning: null,
            modelSelector: null,
            resetBtn: null,
            infoBtn: null
        };

        // Model types
        const modelTypes = {
            cube: { name: 'Khối lập phương', color: 0x007bff },
            sphere: { name: 'Hình cầu', color: 0xff6b6b },
            torus: { name: 'Hình xuyến', color: 0x4ecdc4 },
            teapot: { name: 'Ấm trà', color: 0xffe66d }
        };

        // Initialize everything
        async function init() {
            try {
                console.log('Initializing AR without AR.js...');
                
                // Get DOM elements
                getDOMElements();
                
                // Initialize Three.js
                initThreeJS();
                
                // Initialize camera
                await initCamera();
                
                // Setup event listeners
                setupEventListeners();
                
                // Start AR
                startAR();
                
                console.log('AR initialized successfully');
            } catch (error) {
                console.error('Initialization failed:', error);
                updateStatus('Lỗi: ' + error.message);
                updateInstructions('Vui lòng sử dụng thiết bị có camera và cho phép quyền camera');
            }
        }

        // Get DOM elements
        function getDOMElements() {
            elements.video = document.getElementById('video');
            elements.canvas = document.getElementById('canvas');
            elements.status = document.getElementById('status');
            elements.instructions = document.getElementById('instructions');
            elements.loading = document.getElementById('loading');
            elements.scanning = document.getElementById('scanning');
            elements.modelSelector = document.getElementById('model-selector');
            elements.resetBtn = document.getElementById('reset-btn');
            elements.infoBtn = document.getElementById('info-btn');
        }

        // Initialize Three.js
        function initThreeJS() {
            console.log('Initializing Three.js...');
            
            // Create scene
            scene = new THREE.Scene();
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 0); // Eye level
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: elements.canvas, 
                alpha: true,
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            console.log('Three.js initialized');
        }

        // Initialize camera
        async function initCamera() {
            try {
                console.log('Requesting camera access...');
                
                // Request camera with fallback options
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                elements.video.srcObject = cameraStream;
                
                // Wait for video to be ready
                elements.video.onloadedmetadata = () => {
                    elements.video.play();
                    console.log('Camera started successfully');
                };
                
                console.log('Camera access granted');
            } catch (error) {
                console.error('Camera access failed:', error);
                throw new Error('Không thể truy cập camera. Vui lòng cho phép quyền camera.');
            }
        }

        // Start AR
        function startAR() {
            console.log('Starting AR...');
            
            // Hide loading
            elements.loading.style.display = 'none';
            
            // Update status
            updateStatus('Camera đã sẵn sàng');
            updateInstructions('Chọn mô hình và chạm vào màn hình để đặt');
            showScanningIndicator(false);
            showModelSelector(true);
            
            // Start render loop
            startRenderLoop();
            
            console.log('AR started');
        }

        // Start render loop
        function startRenderLoop() {
            function renderLoop() {
                // Update model animation
                if (placedModel && placedModel.userData.rotationSpeed) {
                    placedModel.rotation.y += placedModel.userData.rotationSpeed;
                    placedModel.rotation.x += placedModel.userData.rotationSpeed * 0.5;
                }
                
                // Render scene
                renderer.render(scene, camera);
                
                animationId = requestAnimationFrame(renderLoop);
            }
            
            renderLoop();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Model selector buttons
            const modelBtns = elements.modelSelector.querySelectorAll('.model-btn');
            modelBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modelType = e.target.dataset.model;
                    selectModel(modelType);
                });
            });
            
            // Control buttons
            elements.resetBtn.addEventListener('click', resetModel);
            elements.infoBtn.addEventListener('click', showInfo);
            
            // Window resize
            window.addEventListener('resize', onWindowResize);
            
            // Canvas click for placing model
            elements.canvas.addEventListener('click', onCanvasClick);
            
            // Touch support for mobile
            elements.canvas.addEventListener('touchend', onCanvasClick);
        }

        // Handle canvas click
        function onCanvasClick(event) {
            event.preventDefault();
            if (placedModel) return;
            
            // Place model at center of screen
            placeModel();
        }

        // Place model
        function placeModel() {
            console.log('Placing model...');
            
            const model = createModel(currentModelType);
            model.position.set(0, 0, -2); // Place 2 meters in front of camera
            scene.add(model);
            
            placedModel = model;
            
            updateStatus('Mô hình đã được đặt');
            updateInstructions('Mô hình đã được đặt! Di chuyển thiết bị để xem từ các góc độ khác');
            showModelSelector(false);
            
            console.log('Model placed');
        }

        // Create model
        function createModel(type) {
            let geometry;
            const material = new THREE.MeshPhongMaterial({ 
                color: modelTypes[type].color,
                shininess: 100
            });
            
            switch (type) {
                case 'cube':
                    geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                    break;
                case 'sphere':
                    geometry = new THREE.SphereGeometry(0.3, 32, 32);
                    break;
                case 'torus':
                    geometry = new THREE.TorusGeometry(0.3, 0.1, 16, 100);
                    break;
                case 'teapot':
                    geometry = new THREE.CylinderGeometry(0.1, 0.2, 0.4, 8);
                    break;
                default:
                    geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            }
            
            const model = new THREE.Mesh(geometry, material);
            model.castShadow = true;
            model.receiveShadow = true;
            
            // Add animation
            model.userData = { rotationSpeed: 0.02 };
            
            return model;
        }

        // Select model type
        function selectModel(type) {
            currentModelType = type;
            
            // Update button states
            const modelBtns = elements.modelSelector.querySelectorAll('.model-btn');
            modelBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.model === type);
            });
            
            console.log('Selected model type:', type);
        }

        // Reset model
        function resetModel() {
            if (placedModel) {
                scene.remove(placedModel);
                placedModel = null;
            }
            
            updateStatus('Camera đã sẵn sàng');
            updateInstructions('Chọn mô hình và chạm vào màn hình để đặt');
            showModelSelector(true);
            
            console.log('Model reset');
        }

        // Show info
        function showInfo() {
            const info = `
                AR Demo - Đặt mô hình 3D
                
                Tính năng:
                • Sử dụng camera để hiển thị mô hình 3D
                • Đặt mô hình trong không gian
                • Xem mô hình từ nhiều góc độ
                • Mô hình tự động xoay
                
                Cách sử dụng:
                1. Cho phép truy cập camera
                2. Chọn loại mô hình
                3. Chạm vào màn hình để đặt mô hình
                4. Di chuyển thiết bị để xem từ các góc khác
                
                Lưu ý: 
                • Mô hình được đặt cố định trong không gian 3D
                • Không có plane detection (cần AR.js cho tính năng này)
                • Hoạt động tốt trên mọi thiết bị có camera
            `;
            
            alert(info);
        }

        // Update status
        function updateStatus(message) {
            elements.status.textContent = message;
        }

        // Update instructions
        function updateInstructions(message) {
            elements.instructions.textContent = message;
        }

        // Show/hide scanning indicator
        function showScanningIndicator(show) {
            elements.scanning.style.opacity = show ? '1' : '0';
        }

        // Show/hide model selector
        function showModelSelector(show) {
            elements.modelSelector.style.opacity = show ? '1' : '0';
        }

        // Handle window resize
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Hide loading screen
        function hideLoading() {
            elements.loading.style.display = 'none';
        }

        // Debug functions
        window.debugAR = () => {
            console.log('=== AR DEBUG ===');
            console.log('Placed Model:', !!placedModel);
            console.log('Current Model Type:', currentModelType);
            console.log('Camera Stream:', !!cameraStream);
            console.log('Video Source:', !!elements.video.srcObject);
            console.log('Scene Children:', scene.children.length);
            console.log('===============');
        };

        window.forcePlaceModel = () => {
            console.log('Force placing model...');
            placeModel();
        };

        window.clearModel = () => {
            console.log('Clearing model...');
            resetModel();
        };

        window.testCamera = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video: true});
                console.log('Camera test successful');
                stream.getTracks().forEach(track => track.stop());
            } catch (error) {
                console.error('Camera test failed:', error);
            }
        };

        // Auto-start when page loads
        window.addEventListener('load', () => {
            console.log('Page loaded, starting AR...');
            hideLoading();
            init();
        });
    </script>
</body>
</html>