<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Plane Detection Experience</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: #000;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            touch-action: none;
        }

        #status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        #instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 15px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        #ar-button {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: linear-gradient(45deg, #007AFF, #5856D6);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,122,255,0.3);
            transition: all 0.3s ease;
        }

        #ar-button:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 6px 25px rgba(0,122,255,0.4);
        }

        #ar-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: translateX(-50%);
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 1001;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Touch controls styling */
        .touch-control {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        #zoom-in {
            bottom: 20px;
            right: 20px;
        }

        #zoom-out {
            bottom: 90px;
            right: 20px;
        }

        /* AR Plane Detection Styles */
        #placement-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 3px solid #00ff00;
            border-radius: 50%;
            z-index: 999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #placement-indicator.visible {
            opacity: 1;
        }

        #placement-indicator.placing {
            border-color: #ff0000;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* AR Controls */
        .ar-control {
            position: absolute;
            padding: 10px 15px;
            background: rgba(0,0,0,0.8);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            cursor: pointer;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        #reset-button {
            top: 10px;
            left: 10px;
        }

        #scan-button {
            top: 50px;
            left: 10px;
        }

        @media (max-width: 768px) {
            #instructions {
                font-size: 12px;
                padding: 12px;
                bottom: 15px;
                left: 15px;
                right: 15px;
            }
            
            #ar-button {
                bottom: 80px;
                padding: 12px 24px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="loading" style="display: none;">
            <div class="spinner"></div>
            <div>ƒêang kh·ªüi t·∫°o AR...</div>
        </div>
        <div id="status">S·∫µn s√†ng</div>
        <button id="ar-button">üöÄ B·∫Øt ƒë·∫ßu AR</button>
        <button id="reset-button" class="ar-control" style="display: none;">üîÑ Reset</button>
        <button id="scan-button" class="ar-control" style="display: none;">üìè Scan Mode</button>
        <div id="placement-indicator"></div>
        <div class="touch-control" id="zoom-in" style="display: none;">+</div>
        <div class="touch-control" id="zoom-out" style="display: none;">‚àí</div>
        <div id="instructions">
            üöÄ Nh·∫•n "B·∫Øt ƒë·∫ßu AR" ‚Üí üìè Qu√©t m·∫∑t ph·∫≥ng ‚Üí üëÜ Ch·∫°m ƒë·ªÉ ƒë·∫∑t model ‚Üí üîÑ Di chuy·ªÉn ƒë·ªÉ xem
        </div>
    </div>

    <!-- AR.js -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threejs.min.js"></script>
    <script>
        // Wait for AR.js to load
        window.addEventListener('load', () => {
            if (typeof THREEx === 'undefined') {
                console.error('THREEx not loaded, trying alternative AR.js source');
                // Load alternative source
                const script = document.createElement('script');
                script.src = 'https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threejs-location-only.js';
                document.head.appendChild(script);
            }
        });
    </script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.155.0/build/three.module.min.js",
                "three/addons/": "https://unpkg.com/three@0.155.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        let scene, camera, renderer, model, placedModel;
        let video, canvas;
        let isARActive = false;
        let isScanning = true;
        let arMode = 'scanning'; // scanning, placing, placed
        
        // AR.js integration
        let arToolkitSource, arToolkitContext, arMarkerControls;
        
        // Elements
        const status = document.getElementById('status');
        const arButton = document.getElementById('ar-button');
        const loading = document.getElementById('loading');
        const resetButton = document.getElementById('reset-button');
        const scanButton = document.getElementById('scan-button');
        const placementIndicator = document.getElementById('placement-indicator');
        const instructions = document.getElementById('instructions');

        // Initialize AR with AR.js
        async function initAR() {
            try {
                loading.style.display = 'block';
                status.textContent = 'ƒêang kh·ªüi t·∫°o AR...';
                
                // Check if THREEx is available
                if (typeof THREEx === 'undefined') {
                    throw new Error('AR.js library ch∆∞a ƒë∆∞·ª£c load. Vui l√≤ng refresh trang.');
                }
                
                // Initialize Three.js
                initThreeJS();
                
                // Initialize AR.js
                initARJS();
                
                // Load 3D model
                await loadModel();
                
                loading.style.display = 'none';
                status.textContent = 'AR ƒë√£ s·∫µn s√†ng - Qu√©t m·∫∑t ph·∫≥ng';
                instructions.textContent = 'üìè Di chuy·ªÉn camera ƒë·ªÉ qu√©t m·∫∑t ph·∫≥ng';
                
                isARActive = true;
                arButton.style.display = 'none';
                resetButton.style.display = 'block';
                scanButton.style.display = 'block';
                
            } catch (error) {
                console.error('AR initialization failed:', error);
                loading.style.display = 'none';
                status.textContent = 'Kh√¥ng th·ªÉ kh·ªüi t·∫°o AR: ' + error.message;
                arButton.disabled = false;
                arButton.textContent = 'üöÄ Th·ª≠ l·∫°i';
            }
        }

        // Initialize Three.js
        function initThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.01, 1000);
            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('canvas'),
                alpha: true,
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            canvas = document.getElementById('canvas');
            video = document.getElementById('video');
        }

        // Initialize AR.js
        function initARJS() {
            try {
                // Create AR.js source
                arToolkitSource = new THREEx.ArToolkitSource({
                    sourceType: 'webcam',
                    sourceWidth: 640,
                    sourceHeight: 480,
                    displayWidth: window.innerWidth,
                    displayHeight: window.innerHeight
                });

                // Initialize AR.js source
                arToolkitSource.init(() => {
                    // Set up video element
                    video.srcObject = arToolkitSource.domElement;
                    video.play();
                    
                    // Set up AR.js context
                    arToolkitContext = new THREEx.ArToolkitContext({
                        cameraParametersUrl: 'https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat',
                        detectionMode: 'mono_and_matrix',
                        matrixCodeType: '3x3',
                        debug: false
                    });
                    
                    arToolkitContext.init(() => {
                        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                    });
                    
                    // Create marker controls for plane detection
                    createPlaneMarker();
                });
            } catch (error) {
                console.warn('AR.js initialization failed, using fallback:', error);
                initARJSFallback();
            }
        }

        // Fallback AR without AR.js
        function initARJSFallback() {
            // Start camera manually
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            }).then(stream => {
                video.srcObject = stream;
                video.play();
                
                // Set up simple camera projection
                camera.aspect = video.videoWidth / video.videoHeight;
                camera.updateProjectionMatrix();
                
                // Create simple plane detection
                createPlaneMarker();
                
                console.log('Fallback AR initialized');
            }).catch(error => {
                console.error('Camera access failed:', error);
                throw error;
            });
        }

        // Create plane marker for detection
        function createPlaneMarker() {
            // Create a large invisible marker that covers the entire view
            const markerGroup = new THREE.Group();
            
            // Add plane detection geometry
            const planeGeometry = new THREE.PlaneGeometry(100, 100);
            const planeMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x00ff00, 
                transparent: true, 
                opacity: 0.1,
                side: THREE.DoubleSide
            });
            const planeMesh = new THREE.Mesh(planeGeometry, planeMaterial);
            planeMesh.rotation.x = -Math.PI / 2;
            planeMesh.position.y = -1;
            markerGroup.add(planeMesh);
            
            scene.add(markerGroup);
        }

        // Load 3D model
        async function loadModel() {
            return new Promise((resolve, reject) => {
                const loader = new GLTFLoader();
                loader.load('./tour360/ekana_stadium_low_poly_lucknow_city_game_asset.glb', 
                    (gltf) => {
                        model = gltf.scene;
                        model.scale.set(0.1, 0.1, 0.1);
                        model.castShadow = true;
                        model.receiveShadow = true;
                        resolve(model);
                    },
                    (progress) => {
                        console.log('Loading progress:', (progress.loaded / progress.total * 100) + '%');
                    },
                    (error) => {
                        console.error('Error loading model:', error);
                        reject(error);
                    }
                );
            });
        }

        // Place model on tap
        function placeModel(x, y) {
            if (!model || arMode !== 'scanning') return;
            
            // Convert screen coordinates to world coordinates
            const vector = new THREE.Vector3();
            vector.set(
                (x / window.innerWidth) * 2 - 1,
                -(y / window.innerHeight) * 2 + 1,
                0.5
            );
            
            // Create placed model
            placedModel = model.clone();
            placedModel.position.copy(vector);
            placedModel.position.z = -1;
            
            scene.add(placedModel);
            
            arMode = 'placed';
            status.textContent = 'Model ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t';
            instructions.textContent = 'üîÑ Di chuy·ªÉn camera ƒë·ªÉ xem model t·ª´ c√°c g√≥c ƒë·ªô kh√°c nhau';
            placementIndicator.classList.remove('visible', 'placing');
            scanButton.textContent = '‚úÖ Model Placed';
        }

        // Reset AR
        function resetAR() {
            if (placedModel) {
                scene.remove(placedModel);
                placedModel = null;
            }
            
            arMode = 'scanning';
            status.textContent = 'AR ƒë√£ s·∫µn s√†ng - Qu√©t m·∫∑t ph·∫≥ng';
            instructions.textContent = 'üìè Di chuy·ªÉn camera ƒë·ªÉ qu√©t m·∫∑t ph·∫≥ng';
            placementIndicator.classList.remove('visible', 'placing');
            scanButton.textContent = 'üìè Scan Mode';
        }

        // Render loop
        function render() {
            if (!isARActive) return;
            
            // Update AR.js if available
            if (arToolkitSource && arToolkitSource.ready && arToolkitContext) {
                arToolkitContext.update(arToolkitSource.domElement);
            }
            
            // Show placement indicator when scanning
            if (arMode === 'scanning') {
                placementIndicator.classList.add('visible');
            } else {
                placementIndicator.classList.remove('visible', 'placing');
            }
            
            // Render scene
            renderer.render(scene, camera);
        }

        // Event listeners
        arButton.addEventListener('click', initAR);
        
        resetButton.addEventListener('click', resetAR);
        
        scanButton.addEventListener('click', () => {
            if (arMode === 'scanning') {
                status.textContent = 'Ch·∫°m v√†o m√†n h√¨nh ƒë·ªÉ ƒë·∫∑t model';
                instructions.textContent = 'üëÜ Ch·∫°m v√†o v·ªã tr√≠ mu·ªën ƒë·∫∑t model';
                placementIndicator.classList.add('placing');
            }
        });
        
        // Handle tap to place
        canvas.addEventListener('click', (e) => {
            if (!isARActive || arMode !== 'scanning') return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            placeModel(x, y);
        });
        
        // Touch support
        canvas.addEventListener('touchstart', (e) => {
            if (!isARActive || arMode !== 'scanning') return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            placeModel(x, y);
        });

        // Window resize
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                
                if (arToolkitSource) {
                    arToolkitSource.onResize();
                }
            }
        });

        // Start render loop
        function animate() {
            requestAnimationFrame(animate);
            render();
        }
        
        animate();
        
        // Debug THREEx availability
        window.addEventListener('load', () => {
            console.log('THREEx available:', typeof THREEx !== 'undefined');
            if (typeof THREEx !== 'undefined') {
                console.log('THREEx version:', THREEx.version || 'unknown');
            }
        });
        
        console.log('AR Plane Detection initialized');
    </script>
</body>
</html>
