<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scroll Canvas Sequence</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
    }

    /* Canvas container */
    .canvas-container {
      position: relative;
      width: 100%;
      height: 400vh;
    }

    .canvas-wrapper {
      width: 100%;
      height: var(--window-height, 100vh);
      position: sticky;
      top: 0;
      left: 0;
    }

    canvas {
      width: 100%;
      height: 100vh;
      object-fit: cover;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      will-change: transform;
    }

    /* Section chứa nội dung để scroll */
    section {
      height: 100vh; /* tăng chiều cao để có đủ scroll */
      position: relative;
      z-index: 0;
      background: #000;
    }

    .second-section {
      height: 500vh; /* tăng chiều cao để có đủ scroll */
      position: relative;
      z-index: 0;
      background: #000;
    }

    /* Tiêu đề overlay */
    .title {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translate(-50%, 0);
      font-size: 3rem;
      font-family: sans-serif;
      color: white;
      z-index: 2;
      /* opacity: 0; */
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
    }
  </style>
</head>
<body>
  <div class="canvas-container">
    <div class="canvas-wrapper">
      <canvas id="hero-canvas"></canvas>
    </div>
  </div>

  <section class="main-section">
    <div class="title">VILLAS IN MARBELLA</div>
  </section>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

  <script>
    gsap.registerPlugin(ScrollTrigger);

    const canvas = document.getElementById("hero-canvas");
    const context = canvas.getContext("2d");

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    const frameCount = 130;
    const images = [];
    let loadedImages = 0;
    
    const currentFrame = (i) =>
      `./images/VILLAS_IN_MARBELLA_Cam_09_v10_${String(i).padStart(5, "0")}.webp`;

    for (let i = 0; i < frameCount; i++) {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        loadedImages++;
        if (loadedImages === frameCount) {
          console.log("All images loaded, initializing ScrollTrigger");
          initScrollTrigger();
        }
      };
      img.onerror = () => {
        console.warn(`Failed to load image ${i}`);
        loadedImages++;
        if (loadedImages === frameCount) {
          initScrollTrigger();
        }
      };
      img.src = currentFrame(i);
      images.push(img);
    }    
    
    setTimeout(() => {
      if (loadedImages < frameCount) {
        initScrollTrigger();
      }
    }, 3000);

    let currentFrameIndex = 0;
    let targetFrameIndex = 0;

    function drawLoop() {
      if (currentFrameIndex !== targetFrameIndex) {
        const nextIndex = currentFrameIndex < targetFrameIndex
          ? currentFrameIndex + 1
          : currentFrameIndex - 1;

        const img = images[nextIndex];
        if (img && img.complete && img.naturalWidth > 0) {
          context.imageSmoothingEnabled = true;
          context.imageSmoothingQuality = 'high';
          context.clearRect(0, 0, canvas.width, canvas.height);
          context.drawImage(img, 0, 0, canvas.width, canvas.height);
          currentFrameIndex = nextIndex;
        }
      }

      requestAnimationFrame(drawLoop);
    }

    function initScrollTrigger() {
      const scrollObj = { frame: 0 };
      
      gsap.to(scrollObj, {
        frame: frameCount - 1,
        ease: "none",
        scrollTrigger: {
          trigger: ".canvas-container",
          start: "top top",
          end: "bottom bottom",
          scrub: true,
          onUpdate: () => {
            const frameIndex = Math.round(scrollObj.frame);
            if (frameIndex >= 0 && frameIndex < frameCount) {
              targetFrameIndex = frameIndex;
            }
          }
        },
      });

      gsap.to(".title", {
        y: () => {
          const section = document.querySelector("section");
          const title = document.querySelector(".title");
          return section.offsetHeight - title.offsetHeight;
        },
        ease: "none",
        scrollTrigger: {
          trigger: "section",
          start: "bottom bottom", // section chạm đáy viewport
          end: "bottom bottom",      // section cuộn hết ra khỏi viewport
          scrub: true,
        },
      });

      targetFrameIndex = 0;
      currentFrameIndex = -1;
      drawLoop();
      
      console.log("ScrollTrigger initialized successfully");
    }
  </script>
</body>
</html>
