<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Cube Simple</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }

        #instructions {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="status">S·∫µn s√†ng</div>
        <div id="instructions">
            üñ±Ô∏è K√©o chu·ªôt ƒë·ªÉ xoay | üîç Cu·ªôn chu·ªôt ƒë·ªÉ zoom
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.155.0/build/three.module.min.js",
                "three/addons/": "https://unpkg.com/three@0.155.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        
        let scene, camera, renderer, model, backgroundSphere;
        let video, canvas;
        let isCameraActive = false;
        let isMouseDown = false;
        let mouseX = 0, mouseY = 0;
        let targetRotationX = 0, targetRotationY = 0;
        let rotationX = 0, rotationY = 0;
        let targetZoom = 5; // Target zoom distance
        let currentZoom = 5; // Current zoom distance
        
        // Auto rotate variables
        let lastMouseActivity = Date.now();
        let isAutoRotating = false;
        const autoRotateDelay = 5000; // 30 gi√¢y
        const autoRotateSpeed = 0.0005; // T·ªëc ƒë·ªô quay t·ª± ƒë·ªông

        const status = document.getElementById('status');

        // Function to reset mouse activity timer
        function resetMouseActivity() {
            lastMouseActivity = Date.now();
            isAutoRotating = false; // D·ª´ng auto rotate khi c√≥ t∆∞∆°ng t√°c
        }

        // Initialize immediately when Three.js loads
        function init() {
            console.log('Starting init function...');
            
            // Scene
            scene = new THREE.Scene();
            console.log('Scene created');

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 5); // N√¢ng camera l√™n m·ªôt ch√∫t
            camera.lookAt(0, 0, 0); // Nh√¨n v√†o t√¢m
            console.log('Camera created');

            // Renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('canvas'),
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            console.log('Renderer created');

            // Video element
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');

            // Set background texture t·ª´ ·∫£nh alma.jpg
            const loader = new THREE.TextureLoader();
            const backgroundTexture = loader.load('./tour360/alma.jpg');
            scene.background = backgroundTexture;
            
            // Simple lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambientLight);
            console.log('Lighting added');

            // Create building model immediately
            createBuilding();
            status.textContent = 'ƒêang t·∫£i model...';
            console.log('Loading GLB model...');

            // Mouse controls
            canvas.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
                resetMouseActivity(); // Reset timer khi c√≥ t∆∞∆°ng t√°c
            });

            canvas.addEventListener('mouseup', () => {
                isMouseDown = false;
                resetMouseActivity(); // Reset timer khi c√≥ t∆∞∆°ng t√°c
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isMouseDown) {
                    const deltaX = e.clientX - mouseX;
                    const deltaY = e.clientY - mouseY;
                    
                    targetRotationY += deltaX * 0.02; // TƒÉng t·ªëc ƒë·ªô xoay
                    targetRotationX += deltaY * 0.02;
                    
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                }
                resetMouseActivity(); // Reset timer khi c√≥ t∆∞∆°ng t√°c
            });

            // Zoom with mouse wheel - smooth zoom
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomSpeed = 0.5;
                if (e.deltaY > 0) {
                    targetZoom += zoomSpeed;
                } else {
                    targetZoom -= zoomSpeed;
                }
                // Gi·ªõi h·∫°n zoom trong kho·∫£ng 2-10
                targetZoom = Math.max(0.1, Math.min(10, targetZoom));
                resetMouseActivity(); // Reset timer khi c√≥ t∆∞∆°ng t√°c
            });

            // Window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // Start animation loop
            animate();

            // Start camera after a short delay
            // setTimeout(startCamera, 1000);

            console.log('init');
            
        }

        function createBuilding() {
            console.log('Loading FBX model...');
            
            // Load FBX model
            const loader = new FBXLoader();
            loader.load('./tour360/can_2pn_lowpoly.fbx', (fbx) => {
                console.log('FBX loaded successfully:', fbx);
                console.log('FBX children count:', fbx.children.length);
                model = fbx;
                
                // Traverse the model to handle missing textures
                model.traverse((child) => {
                    if (child.isMesh && child.material) {
                        // Handle single material
                        if (child.material.map && !child.material.map.image) {
                            child.material.map = null;
                        }
                        // Handle material array
                        if (Array.isArray(child.material)) {
                            child.material.forEach(mat => {
                                if (mat.map && !mat.map.image) {
                                    mat.map = null;
                                }
                            });
                        }
                    }
                });
                
                // ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc v√† v·ªã tr√≠
                model.scale.set(2, 2, 2); // Ph√≥ng to model
                model.position.set(0, 0, 0); // ƒê·∫∑t th·∫•p h∆°n m·ªôt ch√∫t
                
                scene.add(model);
                console.log('FBX model loaded successfully');
                status.textContent = 'Model Hornet ƒë√£ s·∫µn s√†ng';
            }, (progress) => {
                console.log('Loading progress:', (progress.loaded / progress.total * 100) + '%');
                status.textContent = 'ƒêang t·∫£i model... ' + Math.round(progress.loaded / progress.total * 100) + '%';
            }, (error) => {
                console.error('Error loading FBX:', error);
                console.error('Error details:', error.target);
                status.textContent = 'L·ªói t·∫£i model - ' + error.message;
                
                // Fallback: t·∫°o h√¨nh vu√¥ng ƒë·ªè n·∫øu kh√¥ng load ƒë∆∞·ª£c
                model = new THREE.Mesh(
                    new THREE.BoxGeometry(2, 2, 2),
                    new THREE.MeshBasicMaterial({ color: 0xFF0000 })
                );
                model.position.set(0, 0, 0);
                scene.add(model);
                console.log('Fallback: Red cube added');
            });
            
            // T·∫°o sphere background l·ªõn v·ªõi texture alma.jpg
            const textureLoader = new THREE.TextureLoader();
            const texture = textureLoader.load('./tour360/alma.jpg');
            
            backgroundSphere = new THREE.Mesh(
                new THREE.SphereGeometry(50, 32, 32),
                new THREE.MeshBasicMaterial({ 
                    map: texture,
                    side: THREE.BackSide // Hi·ªÉn th·ªã m·∫∑t trong
                })
            );
            backgroundSphere.position.set(0, 0, 0);
            scene.add(backgroundSphere);
            console.log('Background sphere with alma.jpg added');
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // Check for auto rotate activation
            const currentTime = Date.now();
            if (currentTime - lastMouseActivity > autoRotateDelay && !isAutoRotating) {
                isAutoRotating = true;
                console.log('Auto rotate activated');
            }
            
            // Auto rotate logic
            if (isAutoRotating) {
                targetRotationY += autoRotateSpeed; // Quay ch·∫≠m theo tr·ª•c Y
            }
            
            // Smooth rotation - tƒÉng t·ªëc ƒë·ªô ƒë·ªÉ ph·∫£n h·ªìi nhanh h∆°n
            rotationX += (targetRotationX - rotationX) * 0.02;
            rotationY += (targetRotationY - rotationY) * 0.02;
            
            // Smooth zoom
            currentZoom += (targetZoom - currentZoom) * 0.15; // Zoom m∆∞·ª£t h∆°n v·ªõi t·ªëc ƒë·ªô 0.15
            camera.position.z = currentZoom;
            
            if (model) {
                model.rotation.x = rotationX;
                model.rotation.y = rotationY;
            }
            
            // Xoay background sphere theo camera
            if (backgroundSphere) {
                backgroundSphere.rotation.y = rotationY * 0.8; // Xoay ch·∫≠m h∆°n
                backgroundSphere.rotation.x = rotationX * 0.8;
            }
            
            // Render 3D scene
            renderer.render(scene, camera);
            
            // Overlay video
            if (isCameraActive && video.videoWidth > 0) {
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }
        }

        
        // Initialize immediately since THREE is imported
        console.log('Three.js imported successfully');
        init();
    </script>
</body>
</html>
